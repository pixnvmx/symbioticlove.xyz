<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Symbiotic Love</title>
    <link rel="icon" type="image/png" href="logo/logo.png">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Logos with Twitter links -->
    <div class="logo-top-left">
        <a href="https://x.com/symbioticfi" target="_blank">
            <img src="logo/logo.png" alt="Logo">
        </a>
        <a href="https://x.com/pixnvm" target="_blank">
            <img src="logo/logo2.png" alt="Logo 2">
        </a>
    </div>

    <div class="container">
        <div class="guestbook-content">
            <h1>Leave Your Mark</h1>
            <p class="subtitle">Share your love for Symbiotic with the community!</p>
            
            <!-- Guestbook Form -->
            <div class="guestbook-form" id="guestbookForm">
                <div class="form-group">
                    <label for="xHandle">Your X Handle:</label>
                    <input type="text" id="xHandle" name="xHandle" placeholder="@yourusername" required>
                </div>
                
                <div class="form-group">
                    <label for="message">Why do you love Symbiotic?</label>
                    <textarea id="message" name="message" placeholder="Tell us what makes Symbiotic special to you..." required maxlength="280"></textarea>
                    <div class="char-count">
                        <span id="charCount">0</span>/280
                    </div>
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-back" onclick="window.location.href='/secret'">Back</button>
                    <button class="btn btn-publish" onclick="publishMessage()">Publish</button>
                </div>
            </div>
            
                         <!-- Background Messages -->
             <div class="background-messages" id="backgroundMessages">
                 <!-- Messages will float in background -->
             </div>
         </div>
     </div>

     <!-- Message Modal -->
     <div class="message-modal" id="messageModal">
         <div class="modal-content">
             <div class="modal-header">
                 <span class="modal-x-handle"></span>
                 <span class="modal-timestamp"></span>
                 <button class="modal-close" onclick="closeModal()">&times;</button>
             </div>
             <div class="modal-body">
                 <div class="modal-message"></div>
             </div>
             
         </div>
     </div>
        </div>
    </div>

    

    <script>
        // Character counter
        document.getElementById('message').addEventListener('input', function() {
            const count = this.value.length;
            document.getElementById('charCount').textContent = count;
            
            if (count > 250) {
                document.getElementById('charCount').style.color = '#ff6b6b';
            } else if (count > 200) {
                document.getElementById('charCount').style.color = '#ffaa00';
            } else {
                document.getElementById('charCount').style.color = '#c0fd5c';
            }
        });

        // Load existing messages
        function loadMessages() {
            fetch('/api/messages')
                .then(response => response.json())
                .then(messages => {
                    const container = document.getElementById('backgroundMessages');
                    container.innerHTML = '';
                    
                    messages.forEach((msg, index) => {
                        const messageElement = createBackgroundMessage(msg, index);
                        container.appendChild(messageElement);
                    });
                })
                .catch(error => {
                    console.error('Error loading messages:', error);
                });
        }

        // Create background message element
        function createBackgroundMessage(message, index) {
            const element = document.createElement('div');
            element.className = 'background-message';
            element.id = `message-${index}`;
            element.textContent = message.xHandle;
            
            // Random position - place outside the "Leave Your Mark" window area
            let x, y;
            
            // Define the window area (approximately where the form is)
            const windowLeft = 20; // 20% from left
            const windowRight = 80; // 80% from left
            const windowTop = 30; // 30% from top
            const windowBottom = 70; // 70% from top
            
            // Generate position outside the window area
            if (Math.random() < 0.5) {
                // Left or right of the window
                x = Math.random() < 0.5 ? Math.random() * windowLeft : windowRight + Math.random() * (100 - windowRight);
                y = Math.random() * 100;
            } else {
                // Above or below the window
                x = Math.random() * 100;
                y = Math.random() < 0.5 ? Math.random() * windowTop : windowBottom + Math.random() * (100 - windowBottom);
            }
            
            element.style.left = `${x}%`;
            element.style.top = `${y}%`;
            

            
            // Store message data
            element.dataset.message = JSON.stringify(message);
            
            // Add click event
            element.addEventListener('click', function() {
                openModal(message);
            });
            
            return element;
        }

        // Format date
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Publish message
        function publishMessage() {
            const xHandle = document.getElementById('xHandle').value.trim();
            const message = document.getElementById('message').value.trim();
            
            if (!xHandle || !message) {
                alert('Please fill in all fields!');
                return;
            }
            
            if (message.length > 280) {
                alert('Message is too long! Maximum 280 characters.');
                return;
            }
            
            // Check for inappropriate content (n-words and similar)
            const inappropriateWords = [
                'nigger', 'nigga', 'n1gger', 'n1gga', 'n!gger', 'n!gga', 'n1gg3r', 'n1gg4',
                'Ð½ÐµÐ³Ñ€', 'Ð½Ð¸Ð³Ð³ÐµÑ€', 'Ð½Ð¸Ð³Ð°', 'Ð½1Ð³Ð³ÐµÑ€', 'Ð½1Ð³Ð°', 'Ð½!Ð³Ð³ÐµÑ€', 'Ð½!Ð³Ð°'
            ];
            
            const messageLower = message.toLowerCase();
            const hasInappropriateContent = inappropriateWords.some(word => 
                messageLower.includes(word)
            );
            
            if (hasInappropriateContent) {
                alert('Inappropriate content detected. Please use respectful language.');
                return;
            }
            
            const cleanHandle = xHandle.startsWith('@') ? xHandle : '@' + xHandle;
            
            // Send to server
            fetch('/api/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    xHandle: cleanHandle,
                    message: message
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                // Clear form
                document.getElementById('xHandle').value = '';
                document.getElementById('message').value = '';
                document.getElementById('charCount').textContent = '0';
                
                // Reload messages
                loadMessages();
                
                // Show success message
                showSuccessMessage();
            })
            .catch(error => {
                console.error('Error publishing message:', error);
                alert('Failed to publish message. Please try again.');
            });
        }

        // Show success message with share option
        function showSuccessMessage() {
            const shareModal = document.createElement('div');
            shareModal.className = 'share-modal';
            shareModal.innerHTML = `
                <div class="share-content">
                    <h2>Message Published! ðŸŒŸ</h2>
                    <p>Added!</p>
                    <div class="share-actions">
                        <button class="btn-share-now" onclick="shareToXNow()">Share to X</button>
                        <button class="btn-close-share" onclick="closeShareModal()">Close</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(shareModal);
        }

        // Share to X after publishing
        function shareToXNow() {
            fetch('/api/messages')
                .then(response => response.json())
                .then(messages => {
                    if (messages.length > 0) {
                        const latestMessage = messages[0]; // Get the most recent message
                        const shareText = `Just left my mark on the Symbiotic community! ${latestMessage.message} @symbioticfi @pixnvm symbioticstats.xyz`;
                        const shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}`;
                        
                        window.open(shareUrl, '_blank');
                    }
                    closeShareModal();
                })
                .catch(error => {
                    console.error('Error loading messages for sharing:', error);
                    closeShareModal();
                });
        }

        // Close share modal
        function closeShareModal() {
            const shareModal = document.querySelector('.share-modal');
            if (shareModal) {
                shareModal.remove();
            }
        }

        // Modal functions
        let currentMessage = null;

        function openModal(message) {
            currentMessage = message;
            const modal = document.getElementById('messageModal');
            
            modal.querySelector('.modal-x-handle').textContent = message.xHandle;
            modal.querySelector('.modal-timestamp').textContent = formatDate(message.timestamp);
            modal.querySelector('.modal-message').textContent = message.message;
            
            modal.style.display = 'flex';
        }

        function closeModal() {
            const modal = document.getElementById('messageModal');
            modal.style.display = 'none';
            currentMessage = null;
        }

        // Share to X
        function shareToX() {
            if (!currentMessage) return;
            
            const shareText = `Just left my mark on the Symbiotic community! ${currentMessage.message} @symbioticfi @pixnvm symbioticstats.xyz`;
            const shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}`;
            
            window.open(shareUrl, '_blank');
        }

        // Close modal when clicking outside
        document.getElementById('messageModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Load messages on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadMessages();
        });
    </script>
</body>
</html>
